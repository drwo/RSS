---
title: "Setting Up a Data Analysis Server in the VT Cloud"
author:
- Tom Woteki, Statistics, drwo@vt.edu, (THW)
- Bob Settlage, Advanced Research Computing, rsettlag@vt.edu, (RES)
output:
  pdf_document: default
  html_document:
    df_print: paged
  html_notebook: default
---
```{r include = FALSE}
knitr::opts_chunk$set(eval=FALSE)
```

# Introduction
This notebook documents the steps for setting up a powerful R-based data analysis server on a virtual machine (VM) hosted in the VT cloud or  on a late model, multi-core Mac laptop or desktop or equivalent. Once you have completed these steps you will have a VM running the latest versions of R and RStudio Server plus the packages needed for data wrangling, plotting and deep learning, and access to all the statistical analysis packages that are available under R. 

The procedures provided here were tested in two steps involving both of these configurations:

1) First on a VM running Ubuntu 18.04 hosted by VMWare running on a late model multi-core Mac Pro laptop.
2) Then on a "med" size VM running Ubuntu 18.04 in the VT cloud. The procedures should work on any of the available sizes of VMs running 18.04, although we have not tested them on smaller servers.

For installation on a VM in the VT cloud you will need an account provided by VT's Advanced Research Computing (ARC) team. Installation of VMWare, which is licensed software, and installation of an Ubuntu VM hosted by VMWare are not covered here [^1]. 

[^1]:By default VMWare  allocates 1 gigabyte of memory and 1 core to the VM. For the installation described here we allocated 2 cores and 8 gigabytes of memory to the VM. One gigabyte of memory is not sufficient to compile some of the packages required for a successful installation. Less than 8 gigabytes of memory may be sufficient but we have not tested that.

This guide was developed from scripts and discussions available in the public domain. References are provided below. In the section headings of some sections we have indicated which references were the primary sources.

If you are reading this guide as a pdf you can pull the original R Notebook from which it was produced at Woteki's git repository: https://github.com/drwo/RSS. We recommend you download it and import it into RStudio on your local machine and conveniently perform the installation step by step from there. If you have any suggestions or find any errors you can push your comments back to git for incorporation into a later version.

## Components and Order of Installation
The following are the components and the order in which they are installed:

1) The latest version of R
2) The latest open source version of RStudio Server (RSS) [^2]. 
3) Several very useful R packages including tidyverse, which comprises a number of useful packages including dplyr and ggplot2; shiny, for building shiny apps; keras for deep learning modeling; and the packages necessary to knit rmarkdown documents to pdf.
4) MySQL, the open source relational database

[^2]:The commercial version of RStudio Server is licensed.

## Installing From the "bash" Shell
Almost all of the installation process is accomplished using bash shell commands in a terminal window connected to the VM. You should have some familiarity with the bash shell, especially since most of the commands are executed with "root" privileges, meaning that you have unrestricted control over the VM and can render it inoperable. Root privileges are required for most of the installation steps, for example installing various Linux libraries [^3].

[^3]:Should you render the VM inoperable, such as erroneously removing a key system directory making it impossible to reboot the machine, the easiest thing to do would be to discard the VM and start over with a new one.

Prior to performing the installation steps you should ssh into the destination VM from your terminal. We recommend running each command separately, rather than running  entire chunks as a whole so that you can see the result of each command more easily. Either use the Cmd-Option-Enter key combination on a command selection or cut and paste the code to your terminal window.

## Installing R Packages
As mentioned above, a number of useful R packages are installed as part of this process. These installations are done from the R console using the install.packages function. We have specified the library path for installation so that these packages are installed in a site-wide library and available to all users by default. 

## Preliminaries: Setting up an SSH Server - VMWare VM Only
If you are performing this installationon a VM hosted under VMWare you need to install the ssh service before you can ssh into the server.

First log onto the VM directly from VMWare, then execute these commands from its Terminal app:
```{bash}
sudo apt-get install openssh-server
```

Now go to the Settings app on the VM and find the IP address of the server. Now proceed to ssh into your VM from the terminal window here:
```{bash}
ssh <your_user_name>@<your_vm_ip_address>
```


# 1. Installing R (References 1 and 2)

The following commands install the Ubuntu packages for R. The commands mirror those found in references 1 and 2. First we need to add the source of the packages to the sources list. We also want to make sure we get the most recent R, which should be 3.5 as of March 19, 2019.

```{bash}
# Prior to any of this you must have logged into the VM via ssh in your terminal window
# su to root. If you are running this on a VM in the VT cloud this requires 2 factor authentication
sudo su -

apt-get update -y
# Install the packages necessary to add a new repository over HTTPS:
apt install -y apt-transport-https software-properties-common
# Enable the CRAN repository and add the CRAN GPG key to the system
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/'
# Now that the repository is added, update the packages list and install the R package
# Answer yes to any questions concerning installation of components
apt update
apt upgrade
apt-get install r-base r-base-core r-recommended -y
# exit root for now and remain in the terminal window
exit
```

Check to see what version of R is running and do a little computing. It should be the latest version, which as of 3/19/19 is 3.5.x.
```{bash}
R -e "v<-rep(pi,4)+6;v"
```

# 2. Install 64-bit RStudio Server (RSS)
At this point R is installed. If you are still in the R shell quit it.

## 2.1 Create User & Group rstudio
First set up a group called "rstudio" and a user "rstudio" to be in that group. Set the password for the user to be rstudio. This will give you a simple way to allow anyone to log into RSS on the VM for a test drive. Furthermore, below we are going set up the server so that only members of the group rstudio can log into RSS. Therefore you should also add yourself, the administrator of the VM, to group rstudio. 

First log in as root again.
```{bash}
sudo su -
apt-get install gdebi-core -y
groupadd rstudio
# in response to the adduser command set the password for user rstudio = rstudio
adduser -ingroup rstudio rstudio
# add user rstudio to the sudo group. This gives user rstudio root privileges.
usermod -aG sudo rstudio
# add yourself to group rstudio
usermod -aG rstudio <your_user_id>
```

## 2.2 Install RStudio Server
Now install RStudio Server. You should be logged in as root.
```{bash}
# you should be logged in as root
cd ~
wget https://download2.rstudio.org/rstudio-server-1.1.463-amd64.deb
gdebi rstudio-server-1.1.463-amd64.deb
```

## 2.3 Edit rserver.conf
Here we modify /etc/rstudio/rserver.conf so that one must be a member of the group rstudio in order to log into RSS. As noted above, you should have added yourself to this group.

```{bash}
# you should still be logged in as root
# make /etc/rstudio/rserver.conf writeable
chmod 777 /etc/rstudio/rserver.conf
# insert the line that will require membership in group rstudio
echo "auth-required-user-group=rstudio" >> /etc/rstudio/rserver.conf
chmod 755 /etc/rstudio/rserver.conf
# check that RSS is running, and restart so it gets new conf
systemctl status rstudio-server.service
systemctl restart rstudio-server.service
```

RSS is now up and running.

## 2.4 Firewalls and Ports 22 and 8787 (As of April 2, 2019)

There are 2 firewalls that control access to ports on your VM. Ports are the entry point to services such as RSS; RSS listens on port 8787 by default. Your Ubuntu VM comes equipped with a firewall called ufw that you can optionally activate as described below. There is also a firewall on the VT network that sits in front of your VM which likewise controls access to services on your VM. In order for you to log into RSS on the VT VM, port 8787 must be open on the VM and on the network. The following is the default situation depending on where your VM is hosted:

1) If your VM is running under VMWare hosted on a local machine, as described in the introduction, ufw is inactive upon installation and all ports are open. Therefore, you have been able to log in via ssh and you can log into RSS at port 8787 without taking further action. If you choose to activate the firewall you need to open ports 22 (for ssh) and 8787 (for RSS) and any other ports that are required for your applications, such as 80 for websites, 3306 for MySQL (discussed below), etc.
2) If your VM is in the VT cloud, ufw is inactive by default and port 22 is open on the network by default. Therefore you have been able to log into the VM via ssh. However, in order to log into RSS you must request port 8787 be opened on the network along with any other ports you might want.

Since all ports on the VM are open by default in either case, activating the ufw firewall on the VM is optional. The following commands will activate the firewall and open ports 22 and 8787. If you do activate the VM's firewall be certain to open port 22. Otherwise you will not be able to log back into the VM even though the port is open on the network.

First open port 22. You can safely disregard the message that doing so may disrupt services and answer yes to proceed.
```{bash}
# You must be logged in as root, if not already: sudo su -
ufw status verbose
ufw enable
ufw allow 22
```

Now open 8787 and verify the open ports:
```{bash}
ufw allow 8787
ufw status verbose
```

## 2.5 Verify RStudio Server Installation
Now we verify the RSS installation.
```{bash}
rstudio-server verify-installation
rstudio-server status
```

Now that you have successfully installed RSS you should log into it on your VM using http://<your_VMs_ip_address>:8787 to complete the rest of the installation process. You can log into the server as user rstudio but we recommend you log in with your user id. This assumes you added yourself to the group rstudio as recommended above. Logging into RSS on the VM ensures that all R commands will be executed on the server as will all shell commands from the terminal window.

# 3. Install Selected R Packages
This section installs some selected packages into the R site-wide library.

## 3.1 Install Rcpp

```{r}
necessary_packages <- c("plyr","tidyverse", "data.table", "lubridate",
                        "rvest", "readxl", "knitr", "quantmod", "rtweet", "syuzhet")

#quick function to check if a library is installed, if not, install, if so, load
load_libraries <- function(lib_name){
  # lib_name is a character vector of packages I want to load
  if(!(lib_name %in% installed.packages())){
    install.packages(lib_name)
  }
  # require will return true if the library is loaded
  return(require(lib_name, character.only=TRUE))
}

loaded_packages <- sapply(necessary_packages, 
                          function(x) load_libraries(x))
```

The first package to install is Rcpp which is needed to compile packages that are written in C++, such as dplyr. In order to install into the site library we need to log in as root.
```{bash}
# requires 2FA
sudo su -

R
install.packages("Rcpp")
```

Next we install selected packages while still logged in as root. In order to ensure a problem free installation  we install each package individually to catch any errors that might occur such as missing packages or libraries.

## 3.2 Install "tidyverse"
The first package we install is "tidyverse".

Tidyverse is an extremely useful package. We highly recommend that it be a standard part of an R installation. The tidyverse comprises many other packages: broom, cli, crayon, dbplyr, dplyr, forcats, ggplot2, haven, hms, httr, jsonlite, lubridate, magrittr, modelr, pillar,purrr, readr, readxl, reprex, rlang, rstudioapi, rvest, stringr, tibble, tidyr, xml2, tidyverse.

See: https://tidyverse.tidyverse.org/reference/tidyverse_packages.html

In debugging the installation of tidyverse we know that we need to get the following Linux packages: libssl-dev, libxml2-dev, libcurl4-openssl-dev. So we need to exit R and install these.
```{r exit.r}
q()
```
```{bash}
# we are still logged in as root
apt-get install libssl-dev
apt-get install libxml2-dev
apt-get install libcurl4-openssl-dev
```

We are now ready to do a clean install of tidyverse. The installation is time consuming and the output is voluminous.
Note: from above we are still logged in as root. 
```{r}
# renter R as root. Doing so installs the pacakges in the site-wide library
R
install.packages("tidyverse")
```

Check to see if world of the tidyverse has been installed in the site library:
```{r}
pkgs <- c("broom", "cli", "crayon", "dbplyr", "dplyr", "forcats", "ggplot2", "haven", "hms", "httr", "jsonlite", 
          "lubridate", "magrittr", "modelr", "pillar", "purrr", "readr", "readxl", "reprex", "rlang", 
          "rstudioapi", "rvest", "stringr", "tibble", "tidyr", "xml2", "tidyverse")
find.package(pkgs)
```

## 3.3 Install Additional Pacakges
These are packages that THW has found useful in many circumstances. They can be installed now or later, whether in the site-wide library or otherwise. Here we are installing them site-wide.

### rmarkdown
Note: we are still logged in as root using R
```{r}
install.packages("rmarkdown")
```

### knitr
```{r}
install.packages("knitr")
```

### shiny
This throws a lot of warnings regarding deprecated declarations but the installation seems to conclude successfully. However, we have not tested this.
```{r}
install.packages("shiny")
```

### data.table
```{r}
install.packages("data.table")
```

### RMySQL
I use MySQL as an open source relational database. Installation of MySQL is covered below. This requires libmariadbclient-dev. Exit R and get:
```{bash}
# upon exiting R we are still logged in as root
apt-get install libmariadbclient-dev
```
Renter R and install:
```{r}
install.packages("RMySQL")
```

### ggmap & maptools
These are handy for developing map graphics and visualizations. Installation of maptools throws some warnings but appears to install successfully but I have not yet tested it.
```{r}
install.packages("ggmap")
install.packages("maptools")
```

### ineq
```{r}
install.packages("ineq")
```

### Packages for Knitting PDFs (Ref 4)
Installation of the following packages for R and Linux will enable knitting notebooks and rmarkdown documents to PDFs.
```{r}
install.packages(c("caTools", "bitops", "rprojroot"))
```

The 2nd command, downloading fonts and other items, will take 10 to 15 minutes.
```{bash}
sudo apt-get -y install texinfo
sudo apt-get -y install texlive-fonts-extra
sudo apt-get -y install pandoc
```

### Some Additional Packages
These are some additional packages I have found useful from time to time but I do not install them here: DT, DBI, RSQLite, tcltk2, sqldf, boot, Cairo, rgdal, tmap, rgeos. Some of these require additional libraries which if not present will cause errors upon attempting to do the installations. You can then get the libraries with "sudo apt-get install <xxx>" and properly install the desired R package.

# 4. MySQL Installation (Ref 5)
This is a simple installation procedure copied from reference 5. It sets up a MySQL administrator account, mysql, with root privileges. The same commands can be used to grant the VM's owner root privileges.
```{bash}
# login as root
sudo su -
# update apt package index and upgrade
apt update
apt upgrade
apt install mysql-server
systemctl status mysql
```
Now that mysql is running let's secure it and set up administrator accounts. As matter of preference, we are not going to configure the VALIDATE_PASSWORD_PLUGIN, which is not as secure as using it. We also choose to:

1) Remove anonymous users
2) Disallow root to log in remotely
3) Remove test databases tables
4) Reload privileges

```{bash}
# secure the installation with a strong password with options as above and exit
mysql_secure_installation
```
Now log into mysql as root.
```{bash}
sudo mysql
```
Now change the authentication method from auth_socket to mysql_native_password. See Ref 5.
```{mysql}
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your_strong_password_goes_here';
FLUSH PRIVILEGES;
```
Exit and log back into mysql as root. Note: you are not logged in to the VM as root at this point.
```{mysql}
exit
mysql -u root -p
```

Now set up an administrator account, mysql, with root type privileges.
```{mysql}
GRANT ALL PRIVILEGES ON *.* TO 'mysql'@'localhost' IDENTIFIED BY 'MySQL!Warrior' WITH GRANT OPTION;
```
Exit mysql and log in as the user mysql:
```{bash}
exit
mysql -u mysql -p
```
## 4.2 Creating and Additional Admin Account
Note that the admin account we set up is for local log in only. To set up a user that can log in from anywhere with all privileges execute the following commands logged in as the mysql user.

CREATE USER 'some_user'@'%' IDENTIFIED BY 'users_strong_password';
GRANT ALL PRIVILEGES ON *.* TO 'some_user'@'%' IDENTIFIED BY 'users_strong_password' WITH GRANT OPTION;

## 4.1 Accessing MySQL Remotely
MySQL listens on port 3306. Open up the port.
```{bash}
sudo ufw allow 3306
sudo ufw status verbose
```

The default installation of MySQL only allows logging in locally. To enable remote log in you must edit the file /etc/mysql/mysql.conf.d changing the value of bind-address from 127.0.0.1 to 0.0.0.0. We do not cover that here.

## References
The following articles are the sources we consulted to develop this installation kit. There is a great deal of overlap among these guides but also some differences. The installation process tested here is a composite of information from these references and steps that Bob Settlage and I previously tried out.

1) https://linuxize.com/post/how-to-install-r-on-ubuntu-18-04/
2) https://rtask.thinkr.fr/blog/installation-of-r-3-5-on-ubuntu-18-04-lts-and-tips-for-spatial-packages/
3) https://cran.r-project.org/bin/Linux/ubuntu/
4) https://www.edgarsdatalab.com/2017/11/24/setup-an-rstudio-server-in-ubuntu/
5) https://linuxize.com/post/how-to-install-mysql-on-ubuntu-18-04/

